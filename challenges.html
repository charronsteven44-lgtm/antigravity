<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Challenges & Récompenses - ESSOR ACTIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#49e619", "background-dark": "#050505", "surface-dark": "#121212" },
                    fontFamily: { "display": ["Manrope", "sans-serif"] }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-background-dark text-white font-display min-h-screen flex flex-col p-0 sm:p-4 items-center">

    <div
        class="w-full max-w-md bg-[#0F0F0F] sm:rounded-[2.5rem] shadow-2xl min-h-[100dvh] flex flex-col relative overflow-hidden">

        <!-- Header / Level Card -->
        <header class="p-6 pb-12 bg-gradient-to-b from-[#1a2617] to-transparent relative z-10">
            <button onclick="window.history.back()"
                class="absolute top-6 left-6 p-2 rounded-full bg-black/20 text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>

            <div class="mt-8 flex flex-col items-center">
                <!-- Circular Progress with Level -->
                <div class="relative w-32 h-32 flex items-center justify-center mb-4">
                    <!-- SVG Circle BG -->
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="64" cy="64" r="60" stroke="#333" stroke-width="8" fill="transparent" />
                        <circle id="xp-circle" cx="64" cy="64" r="60" stroke="#49e619" stroke-width="8"
                            fill="transparent" stroke-dasharray="377" stroke-dashoffset="100" stroke-linecap="round"
                            class="transition-all duration-1000" />
                    </svg>
                    <div class="absolute flex flex-col items-center">
                        <span class="text-xs text-gray-400 font-bold uppercase">Niveau</span>
                        <span class="text-4xl font-black text-white" id="lvl-display">1</span>
                    </div>
                </div>

                <p class="text-sm font-bold text-gray-400 uppercase tracking-widest"><span id="xp-display">0</span> XP
                    Totaux</p>
                <p class="text-xs text-primary mt-1 font-medium">Prochain niveau : <span id="next-xp">100</span> XP</p>
            </div>
        </header>

        <!-- Challenges List -->
        <main class="flex-1 -mt-6 px-6 pb-24 space-y-6 bg-[#0F0F0F] rounded-t-[2rem] z-20 pt-6">

            <!-- Filters (Fake) -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                <button
                    class="px-4 py-1.5 bg-primary text-black font-bold text-xs rounded-full whitespace-nowrap">Tout</button>
                <button class="px-4 py-1.5 bg-white/5 text-gray-400 font-bold text-xs rounded-full whitespace-nowrap">En
                    Cours</button>
                <button
                    class="px-4 py-1.5 bg-white/5 text-gray-400 font-bold text-xs rounded-full whitespace-nowrap">Terminés</button>
            </div>

            <div id="challenges-container" class="space-y-3">
                <!-- JS will inject items here -->
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="js/gamification-data.js"></script>
    <script src="js/gamification-logic.js"></script>
    <script>
        document.addEventListener('gamification-updated', (e) => {
            renderPage(e.detail);
        });

        // Initial render trigger (logic runs on load)

        function renderPage(state) {
            // Stats
            document.getElementById('lvl-display').textContent = state.level;
            document.getElementById('xp-display').textContent = state.xp;

            const nextLvlXp = GameLogic.getNextLevelXP();
            // Logic to find prev threshold
            let prevThreshold = 0;
            // Simple approach: get current level index logic
            // ... for MVP UI simple bar calc:
            const totalRange = nextLvlXp;
            // Better: offset from previous level base

            document.getElementById('next-xp').textContent = nextLvlXp;

            // Render List
            const container = document.getElementById('challenges-container');
            container.innerHTML = '';

            // Sort: Incomplete first, then Completed
            const sorted = [...CHALLENGES_DB].sort((a, b) => {
                const aDone = state.completed.includes(a.id);
                const bDone = state.completed.includes(b.id);
                return aDone === bDone ? 0 : aDone ? 1 : -1;
            });

            sorted.forEach(c => {
                const isDone = state.completed.includes(c.id);
                const isHidden = c.type === 'hidden' && !isDone;

                let icon = 'military_tech';
                if (c.category === 'fun') icon = 'celebration';
                if (c.category === 'social') icon = 'share';
                if (c.category === 'start') icon = 'flag';
                if (isHidden) icon = 'lock';

                const html = `
                <div class="relative bg-white/5 border ${isDone ? 'border-primary/30' : 'border-white/5'} rounded-2xl p-4 flex items-center gap-4 group overflow-hidden">
                    ${isDone ? '<div class="absolute inset-0 bg-primary/5 pointer-events-none"></div>' : ''}
                    
                    <div class="w-12 h-12 rounded-full ${isDone ? 'bg-primary text-black' : 'bg-white/10 text-gray-500'} flex items-center justify-center shrink-0">
                        <span class="material-symbols-outlined">${isDone ? 'check' : icon}</span>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <h3 class="text-sm font-bold text-white truncate">${isHidden ? 'Challenge Caché' : c.title}</h3>
                        <p class="text-xs text-gray-400 truncate">${isHidden ? '???' : c.desc}</p>
                        
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-[10px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded">+${c.xp} XP</span>
                            ${c.reward !== 'Points' ? `<span class="text-[10px] font-bold text-purple-400 bg-purple-500/10 px-2 py-0.5 rounded flex items-center gap-1"><span class="material-symbols-outlined text-[10px]">card_giftcard</span> ${isDone ? 'Récupéré' : 'À gagner'}</span>` : ''}
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });

            // Circle Progress update (simple visual approx for MVP)
            const pct = Math.min((state.xp / nextLvlXp) * 377, 377);
            // Note: Real formula needs range between levels.
            // For Level 1 (0-100), xp=50 -> 50%.
            document.getElementById('xp-circle').style.strokeDashoffset = 377 - pct;
        }
    </script>
</body>

</html>