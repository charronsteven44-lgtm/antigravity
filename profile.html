<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Mon Profil - ESSOR ACTIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#49e619", "primary-dark": "#36b012", "background-dark": "#0d140b", "surface-dark": "#1a2617" },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: { "DEFAULT": "1rem", "lg": "1.5rem", "2xl": "2.5rem" }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            background-color: #0d140b;
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        .premium-card {
            background: linear-gradient(135deg, #1a2617 0%, #0d140b 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="font-display flex items-center justify-center min-h-screen p-0 sm:p-4">
    <div id="profile-app"
        class="relative flex flex-col h-[100dvh] w-full max-w-md bg-background-dark sm:rounded-[3rem] shadow-2xl overflow-hidden ring-8 ring-black/5 dark:ring-white/5 transition-all duration-300">

        <!-- Header -->
        <header class="flex items-center justify-between px-6 pt-6 pb-2 shrink-0 z-10">
            <button onclick="window.history.back()"
                class="p-2 -ml-2 rounded-full hover:bg-white/10 text-white transition-colors">
                <span class="material-symbols-outlined text-3xl">arrow_back</span>
            </button>
            <h1 class="text-xl font-bold text-white tracking-tight">Mon Profil</h1>
            <div class="w-10"></div>
        </header>

        <main class="flex-1 overflow-y-auto px-6 py-6 pb-24 space-y-8 scroll-hide">

            <!-- Avatar & Identity -->
            <div class="flex flex-col items-center">
                <div class="relative group">
                    <div
                        class="w-32 h-32 rounded-full border-4 border-primary p-1 bg-surface-dark shadow-[0_0_30px_rgba(73,230,25,0.2)]">
                        <div
                            class="w-full h-full rounded-full bg-white/5 flex items-center justify-center overflow-hidden">
                            <img id="avatar-img"
                                src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&q=80&w=200"
                                class="w-full h-full object-cover">
                        </div>
                    </div>
                    <label for="avatar-upload"
                        class="absolute bottom-0 right-0 p-2.5 bg-primary rounded-full text-black shadow-lg cursor-pointer hover:scale-110 active:scale-95 transition-all">
                        <span class="material-symbols-outlined text-[20px] font-bold">photo_camera</span>
                        <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                    </label>
                </div>
                <div class="text-center mt-5">
                    <h2 class="text-2xl font-black text-white" id="user-display-name">Chargement...</h2>
                    <p class="text-primary font-bold text-[10px] uppercase tracking-widest mt-1" id="user-status">Membre
                        Premium</p>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openWeightModal()"
                    class="premium-card p-5 rounded-3xl flex flex-col gap-1 hover:bg-white/5 transition-colors text-left group">
                    <div class="flex justify-between w-full">
                        <span class="text-gray-500 text-[10px] font-bold uppercase tracking-wider">Poids actuel</span>
                        <span
                            class="material-symbols-outlined text-gray-600 text-[16px] group-hover:text-primary transition-colors">edit</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-2xl font-black text-white" id="stat-weight">--</span>
                        <span class="text-gray-400 text-xs font-bold" id="unit-weight">kg</span>
                    </div>
                </button>
                <div class="premium-card p-5 rounded-3xl flex flex-col gap-1">
                    <span class="text-gray-500 text-[10px] font-bold uppercase tracking-wider">Taille</span>
                    <div class="flex items-baseline gap-1">
                        <span class="text-2xl font-black text-white" id="stat-height">--</span>
                        <span class="text-gray-400 text-xs font-bold" id="unit-height">cm</span>
                    </div>
                </div>
            </div>

            <!-- Weight Chart Card -->
            <div class="premium-card p-6 rounded-3xl space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-white font-bold">Évolution Poids</h3>
                    <div class="flex items-center gap-1 bg-white/5 rounded-lg p-1">
                        <button onclick="updateChartRange('1M')"
                            class="chart-filter px-2 py-0.5 text-[10px] font-bold rounded text-black bg-white">1M</button>
                        <button onclick="updateChartRange('3M')"
                            class="chart-filter px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-white">3M</button>
                        <button onclick="updateChartRange('ALL')"
                            class="chart-filter px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-white">TOUT</button>
                    </div>
                </div>
                <div class="h-48 w-full relative">
                    <canvas id="weight-chart"></canvas>
                </div>
            </div>

            <!-- Program Brief Card -->
            <div class="premium-card p-6 rounded-3xl space-y-4">
                <div class="flex justify-between items-center">
                    <div class="space-y-0.5">
                        <h3 class="text-white font-bold" id="prog-title">Programme Essor</h3>
                        <p class="text-gray-500 text-[10px] font-bold uppercase tracking-wider" id="prog-day">Jour 1 sur
                            7</p>
                    </div>
                    <div class="h-10 w-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined">fitness_center</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-[11px] font-bold text-gray-400">
                        <span>Progression</span>
                        <span id="prog-percent">0%</span>
                    </div>
                    <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden">
                        <div id="prog-bar" class="bg-primary h-full rounded-full transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>

                <button onclick="window.location.href='my-program-pro.html'"
                    class="w-full py-3 bg-white/5 hover:bg-white/10 text-white text-xs font-bold rounded-xl border border-white/5 transition-colors">
                    VOIR MA SÉANCE DU JOUR
                </button>
                </button>
            </div>

            <!-- Subscription Status -->
            <div class="space-y-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest pl-1">Abonnement</p>
                <div class="premium-card rounded-3xl overflow-hidden p-5 flex items-center justify-between"
                    id="sub-card">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-800"
                            id="sub-icon-bg">
                            <span class="material-symbols-outlined text-gray-400" id="sub-icon">star</span>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5"
                                id="sub-label">Actuel</p>
                            <h4 class="text-white font-bold" id="sub-name">Chargement...</h4>
                        </div>
                    </div>
                    <button onclick="window.location.href='subscription.html'"
                        class="bg-white/5 hover:bg-white/10 text-xs font-bold px-4 py-2 rounded-xl transition-colors text-gray-300">
                        Gérer
                    </button>
                </div>
            </div>

            <!-- Personal Info List -->
            <div class="space-y-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest pl-1">Informations</p>
                <div class="premium-card rounded-3xl overflow-hidden divide-y divide-white/[0.03]">
                    <div class="flex items-center justify-between p-5">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-gray-500">cake</span>
                            <span class="text-sm font-medium text-gray-300">Âge</span>
                        </div>
                        <span class="text-sm font-bold text-white" id="val-age">--</span>
                    </div>
                    <div class="flex items-center justify-between p-5">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-gray-500">transgender</span>
                            <span class="text-sm font-medium text-gray-300">Genre</span>
                        </div>
                        <span class="text-sm font-bold text-white" id="val-gender">--</span>
                    </div>
                    <div class="flex items-center justify-between p-5">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-gray-500">mail</span>
                            <span class="text-sm font-medium text-gray-300">Email</span>
                        </div>
                        <span class="text-sm font-bold text-white truncate max-w-[150px]" id="val-email">--</span>
                    </div>
                </div>
            </div>

            <!-- Settings & Management -->
            <div class="space-y-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest pl-1">Configuration</p>
                <div class="premium-card rounded-3xl overflow-hidden divide-y divide-white/[0.03]">
                    <button onclick="window.location.href='edit-profile.html'"
                        class="w-full flex items-center justify-between p-5 hover:bg-white/[0.02] transition-colors">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-primary">edit_square</span>
                            <span class="text-sm font-bold text-white">Modifier mon profil</span>
                        </div>
                        <span class="material-symbols-outlined text-gray-600">chevron_right</span>
                    </button>
                    <button
                        class="w-full flex items-center justify-between p-5 hover:bg-white/[0.02] transition-colors">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-gray-500">notifications</span>
                            <span class="text-sm font-bold text-white">Notifications</span>
                        </div>
                        <div class="bg-white/5 px-2 py-0.5 rounded text-[10px] font-bold text-primary">ACTIF</div>
                    </button>
                    <button id="logout-btn"
                        class="w-full flex items-center justify-between p-5 hover:bg-red-500/5 transition-colors group">
                        <div class="flex items-center gap-4">
                            <span
                                class="material-symbols-outlined text-red-500/60 group-hover:text-red-500">logout</span>
                            <span class="text-sm font-bold text-red-500/80 group-hover:text-red-500">Se
                                déconnecter</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="pt-4 pb-8">
                <button id="delete-account-btn"
                    class="w-full py-4 text-xs font-bold text-gray-600 hover:text-red-500/50 transition-colors uppercase tracking-widest">
                    Supprimer mon compte
                </button>
            </div>

        </main>

        <!-- Dynamic Feedback Overlay (for instant feedback) -->
        <div id="feedback-overlay"
            class="fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="bg-primary/10 border border-primary/20 p-8 rounded-[2rem] flex flex-col items-center gap-6">
                <span class="material-symbols-outlined text-primary text-5xl animate-bounce">check_circle</span>
                <p id="feedback-msg" class="text-white font-bold text-center">Modifications enregistrées</p>
            </div>
        </div>

        <!-- Bottom Nav -->
        <nav
            class="absolute bottom-0 left-0 w-full z-50 bg-background-dark/80 backdrop-blur-xl border-t border-white/5 pb-6 pt-2">
            <div class="flex justify-around items-center px-2">
                <a href="client-dashboard.html"
                    class="flex flex-col items-center justify-center gap-1 min-w-[64px] group opacity-60 hover:opacity-100 transition-opacity">
                    <span
                        class="material-symbols-outlined text-[28px] text-white group-hover:text-primary">analytics</span>
                    <span
                        class="text-[10px] font-medium text-white group-hover:text-primary tracking-tight">Tableau</span>
                </a>
                <a href="my-program-pro.html"
                    class="flex flex-col items-center justify-center gap-1 min-w-[64px] group opacity-60 hover:opacity-100 transition-opacity">
                    <span
                        class="material-symbols-outlined text-[28px] text-white group-hover:text-primary">calendar_today</span>
                    <span
                        class="text-[10px] font-medium text-white group-hover:text-primary tracking-tight">Programme</span>
                </a>
                <a href="profile.html" class="flex flex-col items-center justify-center gap-1 min-w-[64px] group">
                    <span class="material-symbols-outlined text-[28px] text-primary">person_fill</span>
                    <span class="text-[10px] font-medium text-primary tracking-tight">Profil</span>
                </a>
            </div>
        </nav>
    </div>


    <!-- Weight Edit Modal -->
    <div id="weight-modal"
        class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeWeightModal()"></div>
        <div class="bg-[#1a1a1a] p-6 rounded-3xl w-full max-w-sm relative z-10 border border-white/10 shadow-2xl transform scale-95 transition-transform duration-300"
            id="weight-modal-content">
            <h3 class="text-white text-lg font-bold mb-4">Mettre à jour mon poids</h3>

            <div class="mb-6">
                <label class="block text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Poids actuel
                    (kg)</label>
                <div class="flex items-center bg-black/30 rounded-xl border border-white/10 px-4 py-2">
                    <input type="number" id="weight-input"
                        class="bg-transparent text-white text-2xl font-bold w-full focus:outline-none"
                        placeholder="00.0" step="0.1">
                    <span class="text-gray-500 font-bold">kg</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeWeightModal()"
                    class="flex-1 py-3 text-sm font-bold text-gray-400 hover:text-white transition-colors">Annuler</button>
                <button onclick="saveWeight()"
                    class="flex-1 py-3 bg-primary hover:bg-primary-dark text-black text-sm font-bold rounded-xl transition-colors shadow-[0_0_20px_rgba(73,230,25,0.3)]">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        let weightChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            const clientData = JSON.parse(localStorage.getItem('clientUser') || '{}');
            const responses = JSON.parse(localStorage.getItem('responses') || '{}');
            const program = JSON.parse(localStorage.getItem('userProgram') || '{}');

            // --- Fill Identity ---
            document.getElementById('user-display-name').textContent = clientData.name || "Utilisateur";
            document.getElementById('val-email').textContent = clientData.email || "--";

            // --- Subscription Logic ---
            const tier = clientData.subscriptionTier || 'free';
            const subNameEl = document.getElementById('sub-name');
            const subIconEl = document.getElementById('sub-icon');
            const subIconBg = document.getElementById('sub-icon-bg');
            const subCard = document.getElementById('sub-card');

            if (tier === 'premium') {
                subNameEl.textContent = 'Membre Premium';
                subNameEl.classList.add('text-primary');
                subIconEl.textContent = 'workspace_premium';
                subIconEl.classList.replace('text-gray-400', 'text-black');
                subIconBg.classList.replace('bg-gray-800', 'bg-primary');
                subCard.classList.add('border-primary/30');
            } else if (tier === 'basic') {
                subNameEl.textContent = 'Abonnement Basique';
                subIconEl.textContent = 'verified';
                subIconEl.classList.replace('text-gray-400', 'text-primary');
                subIconBg.classList.replace('bg-gray-800', 'bg-primary/20');
            } else {
                subNameEl.textContent = 'Essai Gratuit';
                subIconEl.textContent = 'timer';
            }

            // Avatar persistence
            if (clientData.avatar) {
                document.getElementById('avatar-img').src = clientData.avatar;
            }

            // --- Stats ---
            document.getElementById('stat-weight').textContent = clientData.weight || "--";
            document.getElementById('unit-weight').textContent = clientData.weightUnit || "kg";
            document.getElementById('stat-height').textContent = clientData.height || "--";
            document.getElementById('unit-height').textContent = clientData.heightUnit || "cm";

            // --- Personal Info ---
            document.getElementById('val-age').textContent = clientData.age ? `${clientData.age} ans` : "--";
            document.getElementById('val-gender').textContent = clientData.gender || "--";

            // --- Program Status ---
            if (program && program.title) {
                document.getElementById('prog-title').textContent = program.title;
                const regDate = clientData.registrationDate ? new Date(clientData.registrationDate) : new Date();
                const now = new Date();
                const daysDiff = Math.floor((now - regDate) / (1000 * 60 * 60 * 24)) + 1;
                const currentDay = Math.min(Math.max(daysDiff, 1), 7);
                document.getElementById('prog-day').textContent = `Jour ${currentDay} sur 7`;
                const progress = Math.round((currentDay / 7) * 100);
                setTimeout(() => {
                    document.getElementById('prog-percent').textContent = `${progress}%`;
                    document.getElementById('prog-bar').style.width = `${progress}%`;
                }, 300);
            }

            // --- Avatar Upload Simulation ---
            document.getElementById('avatar-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;
                        document.getElementById('avatar-img').src = base64;
                        clientData.avatar = base64;
                        localStorage.setItem('clientUser', JSON.stringify(clientData));
                        showFeedback("Photo mise à jour");
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- Logout & Delete ---
            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm("Voulez-vous vraiment vous déconnecter ?")) {
                    localStorage.removeItem('isClientLoggedIn');
                    localStorage.removeItem('clientUser');
                    window.location.href = 'index.html';
                }
            });
            document.getElementById('delete-account-btn').addEventListener('click', () => {
                if (confirm("ATTENTION : Cette action est irréversible. Toutes vos données seront supprimées. Confirmer ?")) {
                    localStorage.clear();
                    window.location.href = 'index.html';
                }
            });

            // --- WEIGHT CHART LOGIC ---
            // Ensure History Exists
            if (!clientData.weightHistory || !Array.isArray(clientData.weightHistory)) {
                // Migrate existing single value to history if present
                if (clientData.weight) {
                    clientData.weightHistory = [
                        { date: clientData.registrationDate || new Date().toISOString(), weight: parseFloat(clientData.weight) }
                    ];
                } else {
                    clientData.weightHistory = [];
                }
                localStorage.setItem('clientUser', JSON.stringify(clientData));
            }

            initChart(clientData.weightHistory);
        });

        // --- GLOBAL FUNCTIONS (called by onClick) ---

        function openWeightModal() {
            const modal = document.getElementById('weight-modal');
            const content = document.getElementById('weight-modal-content');
            const input = document.getElementById('weight-input');
            const currentWeight = document.getElementById('stat-weight').textContent;

            if (currentWeight && currentWeight !== '--') {
                input.value = currentWeight;
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeWeightModal() {
            const modal = document.getElementById('weight-modal');
            const content = document.getElementById('weight-modal-content');

            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 300);
        }

        function saveWeight() {
            const input = document.getElementById('weight-input');
            const val = parseFloat(input.value);

            if (!val || val <= 0 || val > 300) {
                alert("Veuillez entrer un poids valide.");
                return;
            }

            // 1. Update Object
            const clientData = JSON.parse(localStorage.getItem('clientUser') || '{}');
            clientData.weight = val;

            if (!clientData.weightHistory) clientData.weightHistory = [];

            // Add new entry
            clientData.weightHistory.push({
                date: new Date().toISOString(),
                weight: val
            });

            // 2. Save
            localStorage.setItem('clientUser', JSON.stringify(clientData));

            // 3. Update UI
            document.getElementById('stat-weight').textContent = val;
            closeWeightModal();
            showFeedback("Poids enregistré");

            // 4. Update Chart
            updateChartRange('ALL'); // Refresh chart
        }

        function initChart(historyData) {
            const ctx = document.getElementById('weight-chart').getContext('2d');

            // Prepare Data (Sort by date)
            const sorted = [...historyData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sorted.map(d => new Date(d.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
            const data = sorted.map(d => d.weight);

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(73, 230, 25, 0.5)'); // Primary
            gradient.addColorStop(1, 'rgba(73, 230, 25, 0)');

            if (weightChart) weightChart.destroy();

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Poids (kg)',
                        data: data,
                        borderColor: '#49e619',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#49e619',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#fff',
                            bodyColor: '#49e619',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#666', font: { family: 'Manrope' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666', font: { family: 'Manrope' } }
                        }
                    }
                }
            });
        }

        function updateChartRange(range) {
            const clientData = JSON.parse(localStorage.getItem('clientUser') || '{}');
            let history = clientData.weightHistory || [];

            const now = new Date();
            let filtered = history;

            if (range === '1M') {
                const limit = new Date();
                limit.setMonth(now.getMonth() - 1);
                filtered = history.filter(d => new Date(d.date) >= limit);
            } else if (range === '3M') {
                const limit = new Date();
                limit.setMonth(now.getMonth() - 3);
                filtered = history.filter(d => new Date(d.date) >= limit);
            }

            // highlight buttons
            document.querySelectorAll('.chart-filter').forEach(btn => {
                if (btn.innerText === range || (range === 'ALL' && btn.innerText === 'TOUT')) {
                    btn.classList.add('bg-white', 'text-black');
                    btn.classList.remove('text-gray-400', 'hover:text-white');
                } else {
                    btn.classList.remove('bg-white', 'text-black');
                    btn.classList.add('text-gray-400', 'hover:text-white');
                }
            });

            initChart(filtered.length > 0 ? filtered : history);
        }

        function showFeedback(msg) {
            const overlay = document.getElementById('feedback-overlay');
            document.getElementById('feedback-msg').textContent = msg;
            overlay.style.opacity = '1';
            overlay.style.pointerEvents = 'auto';
            setTimeout(() => {
                overlay.style.opacity = '0';
                overlay.style.pointerEvents = 'none';
            }, 2000);
        }
    </script>
</body>

</html>